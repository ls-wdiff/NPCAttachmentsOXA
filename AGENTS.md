# AGENTS.md

## Project overview
This repo is a Node.js (ESM) toolchain for generating and packaging S.T.A.L.K.E.R. 2 mod configuration files and assets. Most logic lives in `.mts` scripts under `src/` and is run via `node` directly (no build step).

## Local requirements
- Node.js 24+ (needs `.mts` loader support).
- STALKER2ZoneKit (official SDK) installed locally.
- Optional tooling for packaging and publishing:
  - `repak` for quick `.pak` rebuilds.
  - SteamCMD for Steam Workshop publishing.

## Environment variables
Copy `.env.sample` to `.env` and fill paths/secrets. Common vars:
- `SDK_PATH`: STALKER2ZoneKit root path.
- `STALKER2_FOLDER`: game install path.
- `REPAK_PATH`: path to `repak` binary.
- `STEAMCMD_PATH`, `STEAM_USER`, `STEAM_PASS`: Steam publish credentials.
- `MODIO_API`, `MODIO_API_SECRET`: mod.io publish credentials.
- `NODE_TS_TRANSFORMER`: path to TypeScript loader.
- `NEXUSMODS_API_KEY`, `NEXUSMODS_CATEGORY_ID`: Nexus Mods publishing.
- `ALLOW_MERGED_STRUCTS`, `DRY`: optional behavior flags.

## Repo layout
- `src/`: all scripts and utilities (TypeScript `.mts` + a few `.ts`).
- `Mods/`: mod source/config payloads (project-specific content).
- `DLCGameData/`: extracted or staged DLC game data (generated or synced).
- `GameLite/`: staged lightweight game data copy (generated).
- `DesignDocs/`: docs/specs for mods and workflows; treat as the canonical spec location for gameplay/system notes.
- `.env.sample`: environment template.
- `.l1*.cache.zlib`: local caches (ignored by git).

## Key scripts (package.json)
Run with `node` via npm scripts:
- `npm run prepare-configs`: core pipeline to generate config files.
- `npm run pack-inject`: package + inject into game content.
- `npm run cook-inject`: cook assets and inject into game.
- `npm run publish-steam`: publish to Steam Workshop.
- `npm run publish-modio`: publish to mod.io.
- `npm run update-readme`: regenerate mod readme files.
- `npm run push-to-sdk`: push content into SDK project.
- `npm run pull-staged`: pull staged assets into repo.
- `npm run pull-assets`: pull game assets into staging.
- `npm run repack-republish-all`: batch cook/inject for all mods.
- `npm run create-git-branches`: utility to create mod branches.
- `npm run purge-caches`: remove `.cache.zlib` files (safe cleanup).

## Generated/ignored content
The following are git-ignored and should not be committed unless explicitly requested:
- `node_modules/`, `.env`, `GameLite/`, `DLCGameData/`, `sdk/`, `.modio/`, `.nexusmods/`.
- Autogenerated files `raw/`, `steamworkshop/`
- Cache files: `.l1.cache.zlib`, `.l2.cache.zlib`, `.l3.cache.zlib`, `.l1.type-gen.cache.zlib`.
- `types.mts`, `*.zip`, workshop VDF files.

## Development notes
- Scripts are ESM and `.mts`; follow the existing import style and path conventions.
- Prefer `rg` for searching and avoid wide refactors unless asked.
- When touching scripts that integrate external tools (SDK, SteamCMD, repak), keep path/credential handling intact.
- Many scripts read from environment variables; do not hardcode local paths.
- `SDK_PATH` is expected to point at the STALKER2ZoneKit root; cfg source data is under `Stalker2/Content/GameLite` (see `src/base-paths.mts`).

## How to analyze `.cfg` files
- Source of truth is the SDK GameLite tree at `SDK_PATH/Stalker2/Content/GameLite` (this is what `src/base-paths.mts` calls `baseCfgDir`).
- Use `s2cfgtojson/types.mts` for up-to-date typescript types for parsed cfgs.
- Schema reference lives in `node_modules/s2cfgtojson/types.mts`; consult it to confirm field names, optionality, and nested struct shapes.
- Use the existing loaders instead of ad‑hoc parsing:
  - `src/get-cfg-files.mts` to scan and cache file lists.
  - `src/read-file-and-get-structs.mts` to parse a file into typed `Struct` objects.
  - `s2cfgtojson` types (imported across `src/`) define the schema for most prototypes.
- Prefer `node` scripts over manual edits when inspecting or transforming cfgs; most scripts assume ESM and the GameLite base path.
- Keep `.cfg` analysis read‑only unless explicitly asked to generate patch files via `src/get-cfg-file-processor.mts`.

## How to create `.cfg` mods
- Create a new folder under `Mods/<ModName>/` and run command `npm run create-git-branches`, you can use `NODE_PATH` and `NODE_TS_TRANSFORMER` from `.env` file if node refuses to launch. 
- Switch to a newly added git branch called same `<ModName>` from previous step, and run `npm run prepare-configs` once. This command should create `meta.mts` for you.
- Define one or more struct transformers; follow the pattern in `Mods/NoFallDamage/meta.mts` and `Mods/NoQuestCooldown/meta.mts`.
- Always set `transformer.files` to the exact cfg paths you intend to patch (paths are relative to `GameData/` and usually start with `/`). You can also use substring pattern, similar to `Mods/MasterMod/transformQuestNodePrototypes.mts`.
- Use `struct.fork()` to create a patched bare minimum copy. Use `struct.fork(true)` to create a deep copy. When changing nested structs, set `__internal__.bpatch = true` on the nested struct.
- For adding new structs, clone/backfill, set `__internal__.isRoot = true`, and return them from the transformer (see `Mods/HeadlessArmors/meta.mts`).
- Keep edits in transformers and regenerate `raw/` via `npm run prepare-configs`; do not hand-edit `raw/` unless explicitly asked.
- Validate references against GameLite: `ItemPrototypeSID`, `UpgradePrototypeSIDs`, `EffectPrototypeSIDs`, `MeshGeneratorPrototypeSID`. Avoid duplicate UpgradePrototypeSIDs.
- In special cases when mod requires SDK involvement and doesn't modify cfgs, `structTransformers` can be empty (see `Mods/NoEnemyMarkers`).

## Design docs (specs)
- Store new system or gameplay specs in `DesignDocs/` and keep them aligned with GameLite cfgs and `s2cfgtojson` schemas.
- When writing or updating a spec, document: source cfg path(s), field semantics, observed ranges/quirks, and any known anomalies.
- Avoid enumerating large SID lists in specs unless explicitly requested; focus on logic and structure.

## Typical workflows
- **Switch to a working branch**: each git branch points to `master`, scripts pick up current mod name from git branch name.
- **Generate configs**: `npm run prepare-configs` after updating mod data in `Mods/`.
- **Inject into game**: `npm run pack-inject` (fast, cfg-only mods, will break on assets-mods) or `npm run cook-inject` (full cook).
- **Publish**: set `.env` credentials, then `npm run publish-steam` or `npm run publish-modio`.
- **Sync assets**: `npm run pull-assets` or `npm run pull-staged`.

## Testing
No dedicated test command is defined. Test by running `npm run prepare-configs`.

## Safety
- Do not remove local caches or staging directories unless explicitly requested; prefer `npm run purge-caches` for cleanup.
- Avoid destructive git actions unless the user asks.
- If scripts modify local SDK/game paths, confirm expected targets before running.

## Updating Agents.md
- Do not hesitate to update this file, if you find general mechanics that can be memorised for future agentic work.
- Do not hesitate to add DesignDocs, if you find specific cfg mechanics that can be memorised for future agentic work. 
